<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western TTRPG Map</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #2b2b2b;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }
        h1, p {
            user-select: none;
            text-align: center;
            margin-bottom: 10px;
        }
        .app-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .map-tools {
            display: flex;
            gap: 10px;
            padding: 10px 0;
        }
        .map-tools button {
            background-color: #4a4a4a;
            border: 1px solid #5d4037;
            color: #e0e0e0;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .map-tools button:hover {
            background-color: #5d4037;
        }
        .color-palette {
            display: flex;
            gap: 5px;
        }
        .color-swatch {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid #5d4037;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-swatch.active {
            transform: scale(1.2);
            border-color: #e0e0e0;
        }
        .map-container {
            position: relative;
            display: inline-block;
            user-select: none;
            cursor: crosshair;
        }
        .map-container img {
            display: block;
            width: 100%;
            height: auto;
            position: relative;
            z-index: 1;
        }
        .map-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2; /* Canvas over the map */
        }
        .map-pin {
            position: absolute;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 3; /* Pins over the canvas */
        }
        .map-pin svg {
            fill: #d32f2f;
            stroke: #5d4037;
            stroke-width: 2px;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
            transition: transform 0.2s;
        }
        .map-pin:hover svg {
            transform: scale(1.2);
            fill: #ef5350;
        }
        .sidebar {
            position: fixed;
            top: 0;
            right: -350px;
            width: 300px;
            height: 100%;
            background-color: #3e3e3e;
            border-left: 1px solid #5d4037;
            padding: 20px;
            box-sizing: border-box;
            transition: right 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            z-index: 50;
        }
        .sidebar.open {
            right: 0;
        }
        .sidebar-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .sidebar-close {
            background: none;
            border: none;
            color: #e0e0e0;
            font-size: 1.5rem;
            cursor: pointer;
            align-self: flex-end;
            margin-bottom: 10px;
        }
        .sidebar-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .sidebar-form label {
            font-weight: bold;
        }
        .sidebar-form input,
        .sidebar-form textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #5d4037;
            background-color: #4a4a4a;
            color: #e0e0e0;
            border-radius: 3px;
        }
        .sidebar-form button {
            background-color: #d32f2f;
            border: none;
            color: #e0e0e0;
            padding: 10px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .sidebar-form button.save-btn:hover {
            background-color: #a02020;
        }
        .sidebar-form button.delete-btn {
            background-color: #721c1c;
        }
        .sidebar-form button.delete-btn:hover {
            background-color: #521010;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>The Territory</h1>
        <p>Click on a pin to view actions. Double-click on the map to create a new pin.</p>
        <div class="map-tools">
            <button id="pin-tool-btn">Pins</button>
            <button id="draw-tool-btn">Draw</button>
            <div id="color-palette" class="color-palette" style="display:none;">
                <div class="color-swatch active" style="background-color: #d32f2f;" data-color="#d32f2f"></div>
                <div class="color-swatch" style="background-color: #2196f3;" data-color="#2196f3"></div>
                <div class="color-swatch" style="background-color: #4caf50;" data-color="#4caf50"></div>
                <div class="color-swatch" style="background-color: #ffc107;" data-color="#ffc107"></div>
            </div>
        </div>

        <div class="map-container">
            <img id="game-map" src="image.png" alt="TTRPG Map" style="max-width: 100%; height: auto;">
            <canvas id="map-canvas" class="map-canvas"></canvas>
        </div>
    </div>

    <div id="sidebar" class="sidebar">
        <button class="sidebar-close">&times;</button>
        <div class="sidebar-title" id="sidebar-title">New Pin</div>
        <form class="sidebar-form">
            <label for="pin-title">Title</label>
            <input type="text" id="pin-title" required>
            <label for="pin-body">Note</label>
            <textarea id="pin-body" rows="5" required></textarea>
            <button type="submit" id="save-pin-btn" class="save-btn">Save Pin</button>
            <button type="button" id="delete-pin-btn" class="delete-btn" style="display:none;">Delete Pin</button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        let db;
        let auth;
        let userId;
        let pinsRef;
        let drawingsRef;
        let isAuthReady = false;

        const mapContainer = document.querySelector('.map-container');
        const gameMap = document.getElementById('game-map');
        const mapCanvas = document.getElementById('map-canvas');
        const ctx = mapCanvas.getContext('2d');
        const sidebar = document.getElementById('sidebar');
        const sidebarTitle = document.getElementById('sidebar-title');
        const sidebarCloseBtn = document.querySelector('.sidebar-close');
        const pinTitleInput = document.getElementById('pin-title');
        const pinBodyInput = document.getElementById('pin-body');
        const savePinBtn = document.getElementById('save-pin-btn');
        const deletePinBtn = document.getElementById('delete-pin-btn');
        const pinToolBtn = document.getElementById('pin-tool-btn');
        const drawToolBtn = document.getElementById('draw-tool-btn');
        const colorPalette = document.getElementById('color-palette');

        let currentTool = 'pin';
        let isDragging = false;
        let movingPinId = null;
        let activePin = null;

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentColor = '#d32f2f';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        pinsRef = collection(db, `artifacts/${appId}/public/data/pins`);
                        drawingsRef = collection(db, `artifacts/${appId}/public/data/drawings`);
                        isAuthReady = true;
                        listenForPins();
                        listenForDrawings();
                    } else {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }
        
        function listenForPins() {
            if (!isAuthReady) return;
            onSnapshot(pinsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const pinData = change.doc.data();
                    const pinId = change.doc.id;
                    if (change.type === "added") {
                        createPinElement(pinId, pinData);
                    } else if (change.type === "modified") {
                        updatePinElement(pinId, pinData);
                    } else if (change.type === "removed") {
                        removePinElement(pinId);
                    }
                });
            });
        }

        function listenForDrawings() {
            if (!isAuthReady) return;
            onSnapshot(drawingsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const drawingData = change.doc.data();
                    if (change.type === "added") {
                        drawLine(drawingData);
                    }
                });
            });
        }
        
        function createPinElement(id, data) {
            let pin = document.createElement('div');
            pin.className = 'map-pin';
            pin.id = `pin-${id}`;
            pin.style.left = `${data.x}%`;
            pin.style.top = `${data.y}%`;
            pin.dataset.noteTitle = data.title;
            pin.dataset.noteBody = data.body;
            pin.dataset.ownerId = data.ownerId;
            pin.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM12 11.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5z"/>
                </svg>
            `;
            mapContainer.appendChild(pin);
        }

        function updatePinElement(id, data) {
            const pin = document.getElementById(`pin-${id}`);
            if (pin) {
                pin.style.left = `${data.x}%`;
                pin.style.top = `${data.y}%`;
                pin.dataset.noteTitle = data.title;
                pin.dataset.noteBody = data.body;
            }
        }
        
        function removePinElement(id) {
            const pin = document.getElementById(`pin-${id}`);
            if (pin) {
                pin.remove();
            }
        }

        function openSidebar(mode, pin = null) {
            sidebar.classList.add('open');
            sidebarTitle.textContent = mode === 'add' ? 'New Pin' : 'Edit Pin';
            savePinBtn.textContent = mode === 'add' ? 'Save Pin' : 'Update Pin';
            deletePinBtn.style.display = mode === 'add' ? 'none' : 'block';
            
            activePin = pin;
            if (mode === 'edit' && pin) {
                pinTitleInput.value = pin.dataset.noteTitle;
                pinBodyInput.value = pin.dataset.noteBody;
            } else {
                pinTitleInput.value = '';
                pinBodyInput.value = '';
            }
        }

        function closeSidebar() {
            sidebar.classList.remove('open');
            activePin = null;
        }

        // Event listeners
        mapContainer.addEventListener('click', (event) => {
            const target = event.target.closest('.map-pin');
            if (currentTool === 'pin' && target) {
                openSidebar('edit', target);
                event.stopPropagation();
            }
        });

        mapContainer.addEventListener('dblclick', (event) => {
            if (currentTool === 'pin') {
                const rect = gameMap.getBoundingClientRect();
                const x = (event.offsetX / rect.width) * 100;
                const y = (event.offsetY / rect.height) * 100;
                
                openSidebar('add');
                activePin = { x: x, y: y };
            }
        });

        mapContainer.addEventListener('mousedown', (event) => {
            if (currentTool === 'draw') {
                isDrawing = true;
                const rect = mapCanvas.getBoundingClientRect();
                [lastX, lastY] = [event.offsetX, event.offsetY];
            }
        });

        mapContainer.addEventListener('mousemove', (event) => {
            if (!isDrawing || currentTool !== 'draw') return;
            const rect = mapCanvas.getBoundingClientRect();
            const startX = lastX;
            const startY = lastY;
            const endX = event.offsetX;
            const endY = event.offsetY;

            // Normalize coordinates for storage
            const normalizedStartX = (startX / rect.width) * 100;
            const normalizedStartY = (startY / rect.height) * 100;
            const normalizedEndX = (endX / rect.width) * 100;
            const normalizedEndY = (endY / rect.height) * 100;

            drawLine({
                startX: normalizedStartX,
                startY: normalizedStartY,
                endX: normalizedEndX,
                endY: normalizedEndY,
                color: currentColor,
                width: 2
            });

            if (isAuthReady) {
                addDoc(drawingsRef, {
                    startX: normalizedStartX,
                    startY: normalizedStartY,
                    endX: normalizedEndX,
                    endY: normalizedEndY,
                    color: currentColor,
                    width: 2,
                    ownerId: userId
                });
            }

            [lastX, lastY] = [endX, endY];
        });

        mapContainer.addEventListener('mouseup', () => {
            isDrawing = false;
        });

        function drawLine(data) {
            const rect = mapCanvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo((data.startX / 100) * rect.width, (data.startY / 100) * rect.height);
            ctx.lineTo((data.endX / 100) * rect.width, (data.endY / 100) * rect.height);
            ctx.strokeStyle = data.color;
            ctx.lineWidth = data.width;
            ctx.stroke();
        }

        savePinBtn.onclick = async (event) => {
            event.preventDefault();
            const title = pinTitleInput.value;
            const body = pinBodyInput.value;

            if (!title || !body) return;

            if (isAuthReady) {
                if (activePin && activePin.id) {
                    await updateDoc(doc(db, pinsRef.path, activePin.id.replace('pin-', '')), {
                        title: title,
                        body: body
                    });
                } else if (activePin && activePin.x) {
                    await addDoc(pinsRef, {
                        title: title,
                        body: body,
                        x: activePin.x,
                        y: activePin.y,
                        ownerId: userId,
                        createdAt: Date.now()
                    });
                }
            }
            closeSidebar();
        };

        deletePinBtn.onclick = async () => {
            if (activePin && activePin.id && isAuthReady) {
                await deleteDoc(doc(db, pinsRef.path, activePin.id.replace('pin-', '')));
            }
            closeSidebar();
        };

        sidebarCloseBtn.onclick = closeSidebar;

        pinToolBtn.onclick = () => {
            currentTool = 'pin';
            colorPalette.style.display = 'none';
        };
        drawToolBtn.onclick = () => {
            currentTool = 'draw';
            colorPalette.style.display = 'flex';
        };

        document.querySelectorAll('.color-swatch').forEach(swatch => {
            swatch.onclick = () => {
                document.querySelector('.color-swatch.active').classList.remove('active');
                swatch.classList.add('active');
                currentColor = swatch.dataset.color;
            };
        });
        
        // Resize canvas to fit map
        window.addEventListener('load', () => {
            function resizeCanvas() {
                const rect = gameMap.getBoundingClientRect();
                mapCanvas.width = rect.width;
                mapCanvas.height = rect.height;
                // Re-draw all lines on resize if needed
                // For a collaborative app, listening to Firestore is better
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        });

        initializeAppAndAuth();
    </script>
</body>
</html>
