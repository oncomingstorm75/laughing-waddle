<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Western TTRPG Map</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #2b2b2b;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h1, p {
            user-select: none;
        }
        .map-container {
            position: relative;
            display: inline-block;
            cursor: crosshair;
        }
        .map-note {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #5d4037;
            padding: 10px;
            border-radius: 5px;
            color: #2b2b2b;
            z-index: 20;
            max-width: 250px;
            text-align: left;
            display: none;
            word-wrap: break-word;
            transform: translate(15px, 15px); /* Offset from mouse */
            pointer-events: none; /* Allows clicks to pass through to pins */
        }
        .map-pin {
            position: absolute;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 10;
        }
        .map-pin svg {
            fill: #d32f2f;
            stroke: #5d4037;
            stroke-width: 2px;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
            transition: transform 0.2s;
        }
        .map-pin:hover svg {
            transform: scale(1.2);
            fill: #ef5350;
        }
        .pin-actions {
            position: absolute;
            background-color: #3e3e3e;
            border: 1px solid #5d4037;
            border-radius: 5px;
            display: none;
            flex-direction: column;
            z-index: 30;
            padding: 5px;
            transform: translate(15px, 15px);
        }
        .pin-actions button {
            background-color: #4a4a4a;
            border: none;
            color: #e0e0e0;
            padding: 8px;
            margin: 2px;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        .pin-actions button:hover {
            background-color: #5d4037;
        }
    </style>
</head>
<body>

    <h1>The Territory</h1>
    <p>Click on a pin to view actions. Double-click on the map to create a new pin.</p>
    <div class="map-container">
        <img id="game-map" src="image.png" alt="TTRPG Map" style="max-width: 100%; height: auto;">
    </div>
    <div id="note-display" class="map-note"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // Firebase Auth & Firestore Initialization
        let db;
        let auth;
        let userId;
        let pinsRef;
        let isAuthReady = false;

        const mapContainer = document.querySelector('.map-container');
        const gameMap = document.getElementById('game-map');
        const noteDisplay = document.getElementById('note-display');

        // State variables
        let activePin = null;
        let isMoving = false;
        let isDragging = false;
        let movingPinId = null;

        // Use the global variables for Firebase configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Main app initialization function
        async function initializeAppAndAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        pinsRef = collection(db, `artifacts/${appId}/public/data/pins`);
                        isAuthReady = true;
                        // Start listening for pin changes once authenticated
                        listenForPins();
                    } else {
                        // Sign in with custom token or anonymously if not available
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Handle initialization errors gracefully
            }
        }
        
        // Listen for real-time changes to the pins collection
        function listenForPins() {
            if (!isAuthReady) return;

            onSnapshot(pinsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const pinData = change.doc.data();
                    const pinId = change.doc.id;

                    if (change.type === "added") {
                        createPinElement(pinId, pinData);
                    }
                    if (change.type === "modified") {
                        updatePinElement(pinId, pinData);
                    }
                    if (change.type === "removed") {
                        removePinElement(pinId);
                    }
                });
            });
        }
        
        function createPinElement(id, data) {
            let pin = document.createElement('div');
            pin.className = 'map-pin';
            pin.id = `pin-${id}`;
            pin.style.left = `${data.x}%`;
            pin.style.top = `${data.y}%`;
            pin.dataset.noteTitle = data.title;
            pin.dataset.noteBody = data.body;
            pin.dataset.ownerId = data.ownerId;
            pin.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM12 11.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5z"/>
                </svg>
            `;
            mapContainer.appendChild(pin);
        }

        function updatePinElement(id, data) {
            const pin = document.getElementById(`pin-${id}`);
            if (pin) {
                pin.style.left = `${data.x}%`;
                pin.style.top = `${data.y}%`;
                pin.dataset.noteTitle = data.title;
                pin.dataset.noteBody = data.body;
            }
        }
        
        function removePinElement(id) {
            const pin = document.getElementById(`pin-${id}`);
            if (pin) {
                pin.remove();
            }
        }

        function createPinActions(pin) {
            let actionsMenu = document.createElement('div');
            actionsMenu.className = 'pin-actions';
            actionsMenu.style.left = `${pin.style.left}`;
            actionsMenu.style.top = `${pin.style.top}`;
            actionsMenu.innerHTML = `
                <button class="view-note-btn">View Note</button>
                <button class="move-pin-btn">Move</button>
                <button class="delete-pin-btn">Delete</button>
            `;
            mapContainer.appendChild(actionsMenu);
            return actionsMenu;
        }
        
        function removePinActions() {
            const existingMenu = mapContainer.querySelector('.pin-actions');
            if (existingMenu) {
                existingMenu.remove();
            }
        }
        
        // Event listeners for user interaction
        mapContainer.addEventListener('click', (event) => {
            const target = event.target.closest('.map-pin');
            if (target) {
                removePinActions(); // Remove any existing menu
                activePin = target;
                const actionsMenu = createPinActions(activePin);
                actionsMenu.style.display = 'flex';

                actionsMenu.querySelector('.view-note-btn').onclick = () => {
                    noteDisplay.innerHTML = `<h3>${activePin.dataset.noteTitle}</h3><p>${activePin.dataset.noteBody}</p>`;
                    noteDisplay.style.display = 'block';
                    removePinActions();
                };

                actionsMenu.querySelector('.move-pin-btn').onclick = () => {
                    isDragging = true;
                    movingPinId = activePin.id.replace('pin-', '');
                    removePinActions();
                };

                actionsMenu.querySelector('.delete-pin-btn').onclick = async () => {
                    if (isAuthReady) {
                        await deleteDoc(doc(db, pinsRef.path, activePin.id.replace('pin-', '')));
                    }
                    removePinActions();
                };
            } else if (!event.target.closest('.pin-actions')) {
                removePinActions();
                noteDisplay.style.display = 'none';
            }
        });
        
        gameMap.addEventListener('dblclick', async (event) => {
            removePinActions();
            noteDisplay.style.display = 'none';

            const title = prompt("Enter a title for the new pin:");
            if (!title) return;

            const body = prompt("Enter the note for the new pin:");
            if (!body) return;

            if (isAuthReady) {
                const rect = gameMap.getBoundingClientRect();
                const x = (event.offsetX / rect.width) * 100;
                const y = (event.offsetY / rect.height) * 100;
                
                await addDoc(pinsRef, {
                    title: title,
                    body: body,
                    x: x,
                    y: y,
                    ownerId: userId,
                    createdAt: Date.now()
                });
            }
        });

        document.addEventListener('mousemove', (event) => {
            if (isDragging && activePin) {
                const rect = gameMap.getBoundingClientRect();
                const x = (event.clientX - rect.left) / rect.width * 100;
                const y = (event.clientY - rect.top) / rect.height * 100;

                activePin.style.left = `${x}%`;
                activePin.style.top = `${y}%`;

                // Update note position with the pin
                noteDisplay.style.left = `${event.clientX}px`;
                noteDisplay.style.top = `${event.clientY}px`;
            }
        });

        document.addEventListener('mouseup', async (event) => {
            if (isDragging && activePin) {
                isDragging = false;
                const rect = gameMap.getBoundingClientRect();
                const x = (event.clientX - rect.left) / rect.width * 100;
                const y = (event.clientY - rect.top) / rect.height * 100;

                if (isAuthReady && movingPinId) {
                    await updateDoc(doc(db, pinsRef.path, movingPinId), { x: x, y: y });
                    movingPinId = null;
                }
            }
        });

        // Initialize the app on page load
        initializeAppAndAuth();
    </script>
</body>
</html>
